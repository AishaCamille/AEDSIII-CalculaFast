<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalculaFast - Fechamento</title>
    <link rel="icon" href="./assets/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="segundaPagina.css">
  
</head>
<body>
    <div id="container">
        <div id="detalhesComanda">
            <h2 id="tituloComanda">Valor Total</h2>
            
            <div class="total-info">
                <div id="valorTotal">
                    <strong>Valor Total: </strong><span id="valorTotalSpan">R$ 0.00</span>
                </div>
                <div id="valorTotalComGarcom">
                    <strong>Valor Total com 10%: </strong><span id="valorTotalComGarcomSpan">R$ 0.00</span>
                </div>
            </div>
            
            <h3>Consumo por Pessoa (Clique no nome para ver itens)</h3>
            <ul id="consumoPorPessoa">
                <li>Carregando dados...</li>
            </ul>
        </div>
        <div style="margin-top: 30px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
    <h3>
        Buscar Pagamentos por Valor
        <span style="font-size: 0.6em; background: #28a745; color: #fff; padding: 3px 6px; border-radius: 4px; vertical-align: middle;" title="Implementa√ß√£o: B+ Tree">
            B+ Tree
        </span>
    </h3>
    
    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
        <input type="number" id="valorMin" placeholder="M√≠n (R$)" step="0.01" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
        <span>at√©</span>
        <input type="number" id="valorMax" placeholder="M√°x (R$)" step="0.01" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
        
        <button onclick="buscarPorIntervalo()" style="background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">
            üîç Buscar
        </button>
        
        <button onclick="limparBuscaBPT()" style="background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">
            Limpar
        </button>
    </div>

    <div id="resultadoBPT" style="margin-top: 10px; display: none;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #e9ecef;"><th style="text-align: left; padding: 5px;">ID</th><th style="text-align: left; padding: 5px;">Comanda</th><th style="text-align: right; padding: 5px;">Valor</th></tr>
            </thead>
            <tbody id="listaBPT"></tbody>
        </table>
    </div>
</div>
        <div id="historicoPagamentos" style="margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
    <h3>
        Hist√≥rico de Pagamentos (Rela√ß√£o 1:N)
        <span style="font-size: 0.6em; background: #007bff; color: #fff; padding: 3px 6px; border-radius: 4px; vertical-align: middle;" title="Implementa√ß√£o: Hash Extens√≠vel -> Lista Invertida">
            Hash + Lista Invertida
        </span>
    </h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="text-align: left; padding: 8px;">ID Pagto</th>
                <th style="text-align: left; padding: 8px;">Quem Pagou (ID)</th>
                <th style="text-align: right; padding: 8px;">Valor</th>
            </tr>
        </thead>
        <tbody id="listaHistoricoPagamentos">
            <tr><td colspan="3" style="padding: 10px; text-align: center; color: #777;">Nenhum pagamento registrado nesta lista invertida.</td></tr>
        </tbody>
    </table>
</div>
        
        <button class="btn-voltar" onclick="voltarParaPaginaAnterior()">Voltar para a P√°gina Anterior</button>
        <button onclick="finalizarComanda()">Finalizar Comanda</button>
    </div>

    <div id="modalContainer"></div>

    <script>
        const API_URL = 'http://localhost:4567'; 

        // Vari√°vel global
       let DADOS_COMANDA = {
        pessoas: [], 
        totalGeral: 0,
        pagamentos: {} 
    };

        document.addEventListener("DOMContentLoaded", function() {
            const idComanda = localStorage.getItem('idComandaAtiva');
            
            if(!idComanda) {
                console.log("Nenhuma comanda selecionada.");
                window.location.href = 'index.html';
                return;
            }

          //  document.getElementById('tituloComanda').textContent = `Detalhes da Comanda #${idComanda}`;
            carregarDadosDoBanco(idComanda);
        });

        function voltarParaPaginaAnterior() {
            window.location.href = 'produtos.html';
        }

        //  PRINCIPAL 
        async function carregarDadosDoBanco(idComanda) {
            try {
                const resPessoas = await fetch(`${API_URL}/comandas/${idComanda}/pessoas-detalhadas`);
                const listaPessoas = await resPessoas.json();

                if (listaPessoas.erro) throw new Error("Erro do Servidor: " + listaPessoas.erro);
                if (!Array.isArray(listaPessoas)) throw new Error("Resposta inv√°lida do servidor.");

                const resRelacoes = await fetch(`${API_URL}/pessoa-comanda-item/comanda/${idComanda}`);
                const listaRelacoes = await resRelacoes.json();

                const resItens = await fetch(`${API_URL}/itens`);
                const todosItens = await resItens.json();

                const resPagamentos = await fetch(`${API_URL}/pagamentos/comanda/${idComanda}`);
                const listaPagamentos = await resPagamentos.json();
                DADOS_COMANDA.listaPagamentosBruta = listaPagamentos;
                const mapaPagamentos = {};
                if (Array.isArray(listaPagamentos)) {
                    listaPagamentos.forEach(pg => {
                        const val = parseFloat(pg.valorPago);
                        if (mapaPagamentos[pg.idPessoa]) {
                            mapaPagamentos[pg.idPessoa] += val;
                        } else {
                            mapaPagamentos[pg.idPessoa] = val;
                        }
                    });
                }
                DADOS_COMANDA.pagamentos = mapaPagamentos;

                const mapaItens = {};
                todosItens.forEach(item => mapaItens[item.id] = item);

                let totalComanda = 0;
                const pessoasProcessadas = [];

                listaPessoas.forEach(pessoa => {
                    let totalPessoa = 0;
                    const itensConsumidos = [];

                    const relacoesDestaPessoa = listaRelacoes.filter(r => r.idPessoaComanda === pessoa.id);

                    relacoesDestaPessoa.forEach(rel => {
                    const itemCompleto = mapaItens[rel.idItem];
                    if (itemCompleto) {
                         const qtd = rel.quantidade || 1; 
                        const subtotal = itemCompleto.valor * qtd;
                        totalPessoa += subtotal;
                        
                        itensConsumidos.push({
                            nome: itemCompleto.descricao,
                            valor: itemCompleto.valor, // Valor unit√°rio
                            quantidade: qtd,           // Guarda a quantidade para exibir no modal
                            totalItem: subtotal        // Total deste item
                        });
                    }
                });

                    totalComanda += totalPessoa;

                    pessoasProcessadas.push({
                        id: pessoa.id,
                        nome: pessoa.nome,
                        total: totalPessoa,
                        itens: itensConsumidos
                    });
                });

                DADOS_COMANDA.pessoas = pessoasProcessadas;
                DADOS_COMANDA.totalGeral = totalComanda;

                renderizarTela();

            } catch (erro) {
                console.error(erro);
                document.getElementById('consumoPorPessoa').innerHTML = `<li style="color:red">Erro ao carregar dados: ${erro.message}</li>`;
            }
        }

        function renderizarTela() {
            const total = DADOS_COMANDA.totalGeral;
            document.getElementById("valorTotalSpan").textContent = `R$ ${total.toFixed(2)}`;
            document.getElementById("valorTotalComGarcomSpan").textContent = `R$ ${(total * 1.10).toFixed(2)}`;

            const listaUl = document.getElementById("consumoPorPessoa");
            listaUl.innerHTML = '';

            if (DADOS_COMANDA.pessoas.length === 0) {
                listaUl.innerHTML = '<li>Ningu√©m adicionado a esta comanda ainda.</li>';
                return;
            }

            DADOS_COMANDA.pessoas.forEach(p => {
                const valorComGarcom = p.total * 1.10;
                const jaPagouTotal = DADOS_COMANDA.pagamentos[p.id] || 0;
                const estaPago = jaPagouTotal >= (valorComGarcom - 0.01);
                const li = document.createElement("li");
                let statusHtml = '';
                if (p.total > 0) {
                if (estaPago) {
                    statusHtml = '<span style="color:green; font-weight:bold; margin-left:10px;">‚úÖ Pago</span>';
                } else {
                    statusHtml = `<button class="btn-pagar" onclick="realizarPagamento(${p.id}, ${p.total}, this)">Registrar Pagamento</button>`;
                }
            }

               li.innerHTML = `
                    <span class="nome" onclick="abrirModalItens(${p.id})">
                        ${p.nome} 
                        <span style="font-size: 0.7em; background: #e0e0e0; color: #555; padding: 2px 4px; border-radius: 4px; margin-left: 5px;" title="Recuperado via √çndice Secund√°rio (Inverted List)">
                            Hash/Index
                        </span>
                    </span>
                    <span class="valor">R$ ${valorComGarcom.toFixed(2)}</span>
                    ${statusHtml}
                `;
                
                listaUl.appendChild(li);
            });
            const tbodyPagamentos = document.getElementById("listaHistoricoPagamentos");
            tbodyPagamentos.innerHTML = '';

            if (DADOS_COMANDA.listaPagamentosBruta && DADOS_COMANDA.listaPagamentosBruta.length > 0) {
                DADOS_COMANDA.listaPagamentosBruta.forEach(pg => {
                    const pessoa = DADOS_COMANDA.pessoas.find(p => p.id === pg.idPessoa);
                    const nomePessoa = pessoa ? pessoa.nome : `ID ${pg.idPessoa}`;
                    
                    const tr = document.createElement("tr");
                    tr.style.borderBottom = "1px solid #eee";
                    tr.innerHTML = `
                        <td style="padding: 8px;">#${pg.id}</td>
                        <td style="padding: 8px;">${nomePessoa}</td>
                        <td style="padding: 8px; text-align: right;">R$ ${parseFloat(pg.valorPago).toFixed(2)}</td>
                    `;
                    tbodyPagamentos.appendChild(tr);
                });
            } else {
                tbodyPagamentos.innerHTML = '<tr><td colspan="3" style="padding: 10px; text-align: center; color: #777;">A lista invertida desta comanda est√° vazia.</td></tr>';
            }
        }

        // --- MODAL DE DETALHES ---
        function abrirModalItens(idPessoa) {
            const pessoa = DADOS_COMANDA.pessoas.find(p => p.id === idPessoa);
            if (!pessoa) return;

            const resumoItens = {};
            pessoa.itens.forEach(item => {
                 if (resumoItens[item.nome]) {
                   resumoItens[item.nome].qtd += item.quantidade;
                    resumoItens[item.nome].total += item.totalItem;
                } else {
                    resumoItens[item.nome] = {
                        qtd: item.quantidade,
                        valorUnit: item.valor,
                        total: item.totalItem
                    };
                }
            });

            let linhas = '';
            if (Object.keys(resumoItens).length === 0) {
                linhas = '<tr><td colspan="4">Nenhum consumo registrado.</td></tr>';
            } else {
                for (const [nome, dados] of Object.entries(resumoItens)) {
                    linhas += `
                        <tr>
                            <td>${nome}</td>
                            <td style="text-align:center">${dados.qtd}</td>
                            <td>R$ ${dados.valorUnit.toFixed(2)}</td>
                            <td>R$ ${dados.total.toFixed(2)}</td>
                        </tr>
                    `;
                }
            }

             const modalHTML = `
                <div id="modalItens" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="document.getElementById('modalItens').remove()">&times;</span>
                        <h2>Consumo de ${pessoa.nome}</h2>
                        <table class="tabela-modal" style="width:100%; border-collapse: collapse; margin-top:10px;">
                            <thead>
                                <tr style="background:#eee; text-align:left;">
                                    <th>Item</th>
                                    <th style="text-align:center">Qtd</th>
                                    <th>Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>${linhas}</tbody>
                        </table>
                        <div style="margin-top: 15px; text-align: right; font-size: 1.2em;">
                            Total: <strong>R$ ${pessoa.total.toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
        }

        async function finalizarComanda() {
            if(!confirm("J√° vai?")) return;
            
            const idComanda = localStorage.getItem('idComandaAtiva');
            if(!idComanda) {
                localStorage.clear();
                window.location.href = 'index.html';
                return;
            }
            try {
                const comandaUpdate = {
                    id: parseInt(idComanda),
                    status: "FECHADA",
                    idPessoa: 1, 
                    consumoPessoa: DADOS_COMANDA.totalGeral
                };

                await fetch(`${API_URL}/comandas/${idComanda}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(comandaUpdate)
                });

                console.log("Comanda Fechada com Sucesso!");
                localStorage.clear();
                //localStorage.removeItem('idComandaAtiva');
                window.location.href = 'index.html';

            } catch (e) {
                console.log("Erro ao fechar: " + e.message);
                console.log("Erro ao fechar: " + e.message);
               if(confirm("Houve um erro t√©cnico, mas deseja sair mesmo assim?")) {
                    localStorage.clear();
                    window.location.href = 'index.html';
                }
            }
        }

       async function realizarPagamento(idPessoaComanda, valorTotal, btnElement) {
  
    const idComanda = localStorage.getItem('idComandaAtiva');
    if (!idComanda) {
        alert("Erro: ID da comanda n√£o encontrado.");
        return;
    }

   
    const novoPagamento = {
        idPessoa: parseInt(idPessoaComanda), // ID do participante
        idComanda: parseInt(idComanda),
        valorPago: valorTotal * 1.1, // Valor com 10%
     };

    try {
        const response = await fetch(`${API_URL}/pagamentos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(novoPagamento)
        });

        const resultado = await response.json();

       if (response.ok) {
                    console.log("Pagamento registrado com sucesso!");
                    
                   
                    const liPai = btnElement.parentElement;
                    btnElement.remove();
                    liPai.insertAdjacentHTML('beforeend', '<span style="color:green; font-weight:bold; margin-left:10px;">‚úÖ Pago</span>');
                    
                   
                    adicionarLinhaAoHistorico(resultado.id, novoPagamento.idPessoa, novoPagamento.valorPago);
                         if (!DADOS_COMANDA.pagamentos[novoPagamento.idPessoa]) {
                        DADOS_COMANDA.pagamentos[novoPagamento.idPessoa] = 0;
                    }
                    DADOS_COMANDA.pagamentos[novoPagamento.idPessoa] += novoPagamento.valorPago;

                } else {
                    throw new Error(resultado.erro || "Falha ao registrar pagamento.");
                }
            } catch (error) {
                console.error(error);
                alert("Erro: " + error.message);
            }
        }
        function adicionarLinhaAoHistorico(idPagamento, idPessoa, valorPago) {
            const tbody = document.getElementById("listaHistoricoPagamentos");

            if (tbody.innerText.includes("Nenhum pagamento")) {
                tbody.innerHTML = '';
            }

            const pessoaObj = DADOS_COMANDA.pessoas.find(p => p.id === idPessoa);
            const nomePessoa = pessoaObj ? pessoaObj.nome : `ID ${idPessoa}`;

            const novaLinha = document.createElement("tr");
            novaLinha.style.borderBottom = "1px solid #eee";
            novaLinha.style.backgroundColor = "#e8f5e9";
            
            novaLinha.innerHTML = `
                <td style="padding: 8px;">#${idPagamento}</td>
                <td style="padding: 8px;">${nomePessoa}</td>
                <td style="padding: 8px; text-align: right;">R$ ${valorPago.toFixed(2)}</td>
            `;

            tbody.appendChild(novaLinha);
            
            setTimeout(() => {
                novaLinha.style.backgroundColor = "transparent";
                novaLinha.style.transition = "background-color 1s";
            }, 2000);
        }
        // --- BUSCA B+ TREE ---

async function buscarPorIntervalo() {
    const min = document.getElementById('valorMin').value;
    const max = document.getElementById('valorMax').value;
    const divResultado = document.getElementById('resultadoBPT');
    const tbody = document.getElementById('listaBPT');

    if (!min || !max) {
        alert("Digite o valor m√≠nimo e m√°ximo.");
        return;
    }

    tbody.innerHTML = '<tr><td colspan="3">Buscando na √Årvore B+...</td></tr>';
    divResultado.style.display = 'block';

    try {
        const res = await fetch(`${API_URL}/pagamentos/busca/intervalo?min=${min}&max=${max}`);
        const pagamentos = await res.json();

        tbody.innerHTML = '';

        if (pagamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">Nenhum pagamento encontrado neste intervalo.</td></tr>';
            return;
        }

        pagamentos.forEach(pg => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 5px;">#${pg.id}</td>
                <td style="padding: 5px;">${pg.idComanda}</td>
                <td style="padding: 5px; text-align: right;">R$ ${pg.valorPago.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });

    } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="3" style="color:red">Erro na busca.</td></tr>';
    }
}

function limparBuscaBPT() {
    document.getElementById('valorMin').value = '';
    document.getElementById('valorMax').value = '';
    document.getElementById('resultadoBPT').style.display = 'none';
}

        window.onclick = function(event) {
            const modal = document.getElementById('modalItens');
            if (event.target === modal) modal.remove();
        }
    </script>
</body>
</html>
