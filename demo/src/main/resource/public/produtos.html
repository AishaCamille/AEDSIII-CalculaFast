<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalculaFast - Adicionar Produtos</title>
    <link rel="icon" href="./assets/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="produtos.css">

    <style>
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px;
            border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px;
        }
        .close {
            color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .itens-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .itens-table th, .itens-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .itens-table th { background-color: #f2f2f2; }
    </style>
</head>

<body>
    <a id="header" href="index.html">
        <img src="./assets/outraOUTRa.png" alt="Logo" id="logo">
    </a>

    <div class="container">
        <h1>Cadastre seus Produtos!</h1>

        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ddd;">
            <label style="font-weight:bold;">üîç Pesquisa Inteligente (Busca no Banco):</label>
            
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <input type="text" id="campoBusca" placeholder="Digite o nome do item..." onkeyup="filtrarItens()" 
                       style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                
                <div style="display: flex; flex-direction: column; justify-content: center; font-size: 0.85em;">
                    <label style="cursor: pointer; margin-bottom: 2px;">
                        <input type="radio" name="algoritmo" value="1" checked onchange="filtrarItens()"> KMP
                    </label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="algoritmo" value="2" onchange="filtrarItens()"> Boyer-Moore
                    </label>
                </div>
            </div>
            <small style="color: #666;">O sistema filtrar√° a lista abaixo usando o algoritmo selecionado.</small>
        </div>

        <div class="form-group">
            <label for="selecionarItem" class="form-label">Item Selecionado:</label>
            <div class="select-wrapper">
                <select id="selecionarItem" class="custom-select" onchange="carregarItemSelecionado()">
                    <option value="">-- Novo Item --</option>
                </select>
                <div class="select-arrow"><svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></div>
            </div>
        </div>

        <div id="msgSucesso" style="display:none; background-color: #d4edda; color: #155724; padding: 10px; border: 1px solid #c3e6cb; border-radius: 5px; margin-bottom: 15px; text-align: center;">
            ‚úÖ Opera√ß√£o realizada com sucesso!
        </div>

        <label for="nomeProduto">Nome do Produto:</label>
        <input type="text" id="nomeProduto">

        <label for="valorProduto">Valor Unit√°rio (R$):</label>
        <input type="number" id="valorProduto" step="0.01" placeholder="0.00">

        <label for="quantidadeProduto">Quantidade:</label>
        <input type="number" id="quantidadeProduto" min="1" value="1">

        <div id="pessoasCheckbox">
            <p>Carregando pessoas da comanda...</p>
        </div>

        <div class="botoes-centro">
            <button onclick="salvarProduto()">Salvar / Vincular</button>
            <button class="btn-ver-itens" onclick="abrirModalItens()" style="background-color: #17a2b8;">Gerenciar Itens</button>
            <button class="btn-voltar" onclick="window.location.href='pessoas.html'">Voltar</button>
            <button class="btn-voltar" onclick="window.location.href='segundaPagina.html'">Finalizar</button>
        </div>

        <div id="logTecnico" style="margin-top: 20px; background: #333; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; display: none;">
            <strong>LOG DO SISTEMA (DEBUG):</strong><br>
            <div id="logContent"></div>
        </div>
    </div>

    <div id="modalItens" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalItens()">&times;</span>
            <h2>Itens Cadastrados</h2>
            <div id="listaItens">Carregando...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:4567'; 
        let timeoutBusca = null;
        let listaItensCache = [];
        const ID_COMANDA_ATUAL = localStorage.getItem('idComandaAtiva');

        // --- INICIALIZA√á√ÉO ---
        window.addEventListener('DOMContentLoaded', () => {
            if (!ID_COMANDA_ATUAL) {
                alert("Nenhuma comanda ativa!");
                window.location.href = 'index.html';
                return;
            }
            carregarItensDoBanco(); // Carrega lista inicial
            carregarPessoasDaComanda(); // Carrega checkboxes
        });

        // --- 1. BUSCA INTELIGENTE (KMP / BOYER-MOORE) ---
        function filtrarItens() {
            clearTimeout(timeoutBusca);
            const termo = document.getElementById('campoBusca').value;

            if (!termo.trim()) {
                carregarItensDoBanco(); // Se vazio, restaura lista completa
                return;
            }

            // Delay de 300ms para n√£o travar enquanto digita
            timeoutBusca = setTimeout(() => {
                executarBuscaNoJava(termo);
            }, 300);
        }

        async function executarBuscaNoJava(termo) {
            const algoritmo = document.querySelector('input[name="algoritmo"]:checked').value;
            const select = document.getElementById('selecionarItem');
            select.innerHTML = '<option>Filtrando...</option>';

            try {
                // Chama a rota Java que usa suas classes KMP/BoyerMoore
                const res = await fetch(`${API_URL}/itens/busca/${encodeURIComponent(termo)}?metodo=${algoritmo}`);
                const itens = await res.json();
                
                listaItensCache = itens; // Atualiza cache
                popularSelect(itens);

            } catch (e) {
                console.error(e);
                select.innerHTML = '<option>Erro na busca</option>';
            }
        }

        // --- 2. CARREGAMENTO DE DADOS ---
        function carregarItensDoBanco() {
            fetch(`${API_URL}/itens`)
                .then(res => res.ok ? res.json() : [])
                .then(itens => {
                    listaItensCache = itens;
                    popularSelect(itens);
                });
        }

        function popularSelect(itens) {
            const select = document.getElementById('selecionarItem');
            select.innerHTML = '<option value="">-- Novo Item --</option>';
            
            if (itens.length === 0) {
                const opt = document.createElement('option');
                opt.disabled = true;
                opt.textContent = "‚ùå Nenhum item encontrado";
                select.appendChild(opt);
            } else {
                itens.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = `${item.descricao} - R$ ${item.valor}`;
                    select.appendChild(opt);
                });
            }
        }

        function carregarItemSelecionado() {
            const idItem = document.getElementById('selecionarItem').value;
            const nomeInput = document.getElementById('nomeProduto');
            const valorInput = document.getElementById('valorProduto');

            if (!idItem) {
                // Modo Novo Item: Limpa campos
                nomeInput.value = "";
                valorInput.value = "";
            } else {
                // Modo Edi√ß√£o: Preenche campos com dados do cache
                const item = listaItensCache.find(i => i.id == idItem);
                if (item) {
                    nomeInput.value = item.descricao;
                    valorInput.value = item.valor;
                }
            }
        }

        function carregarPessoasDaComanda() {
            fetch(`${API_URL}/pessoas-comanda/comanda/${ID_COMANDA_ATUAL}`)
                .then(res => res.json())
                .then(pessoas => {
                    const div = document.getElementById('pessoasCheckbox');
                    if (!pessoas || pessoas.length === 0) {
                        div.innerHTML = '<p style="color:red">Ningu√©m na comanda.</p>';
                        return;
                    }
                    
                    let html = `<label>Quem vai consumir?</label>`;
                    pessoas.forEach(p => {
                        html += `
                        <div style="margin-bottom: 5px; border-bottom: 1px dashed #ccc; padding: 5px; display: flex; justify-content: space-between;">
                            <div>
                                <input type="checkbox" class="chk-pessoa" id="chk_${p.id}" value="${p.id}">
                                <label for="chk_${p.id}" style="font-weight: bold;">${p.nome}</label>
                            </div>
                            <div>
                                <small>Qtd:</small>
                                <input type="number" id="qtd_${p.id}" min="1" value="1" style="width:50px;">
                            </div>
                        </div>`;
                    });
                    div.innerHTML = html;
                });
        }

        // --- 3. SALVAR E VINCULAR ---
        async function salvarProduto() {
            const idItemSelect = document.getElementById('selecionarItem').value;
            const nome = document.getElementById('nomeProduto').value;
            const valor = parseFloat(document.getElementById('valorProduto').value);
            const qtdEstoque = parseInt(document.getElementById('quantidadeProduto').value);

            if (!nome || isNaN(valor)) {
                alert("Preencha nome e valor.");
                return;
            }

            const checkboxes = document.querySelectorAll('.chk-pessoa:checked');

            let idItemFinal = idItemSelect;

            try {
                const dadosItem = { descricao: nome, valor: valor, quantidade: qtdEstoque };

                // Se n√£o tem ID selecionado, cria novo (POST). Se tem, atualiza (PUT).
                if (!idItemFinal) {
                    const res = await fetch(`${API_URL}/itens`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(dadosItem)
                    });
                    const criado = await res.json();
                    idItemFinal = criado.id || criado.itemId; // Pega ID gerado
                } else {
                    const res = await fetch(`${API_URL}/itens/${idItemFinal}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(dadosItem)
                    });
                }
                if (!idItemFinal) {
                    const lista = await fetch(`${API_URL}/itens`).then(r => r.json());
                    idItemFinal = lista[lista.length - 1].id;
                }

                // Vincula o item (novo ou existente) √†s pessoas selecionadas
                if (checkboxes.length > 0) {
                    const promises = Array.from(checkboxes).map(chk => {
                        const idPessoa = chk.value;
                        const qtdIndividual = document.getElementById(`qtd_${idPessoa}`).value;
                        
                        return fetch(`${API_URL}/pessoa-comanda-item`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                idPessoaComanda: parseInt(idPessoa),
                                idComanda: parseInt(ID_COMANDA_ATUAL),
                                idItem: parseInt(idItemFinal),
                                quantidade: parseInt(qtdIndividual)
                            })
                        });
                    });
                    await Promise.all(promises);
                }

                // Feedback Visual
                exibirSucesso(checkboxes.length > 0); 
                 exibirLogTecnico(checkboxes, idItemFinal);
                
                // Limpeza
                carregarItensDoBanco(); // Recarrega lista
                document.getElementById('selecionarItem').value = "";
                document.getElementById('nomeProduto').value = "";
                document.getElementById('valorProduto').value = "";
                document.getElementById('quantidadeProduto').value = "1";
                checkboxes.forEach(c => c.checked = false);

            } catch (e) {
                console.error(e);
                alert("Erro ao salvar: " + e.message);
            }
        }

        // --- 4. FUN√á√ïES DE MODAL E GERENCIAMENTO ---
        function abrirModalItens() {
            document.getElementById('modalItens').style.display = 'block';
            listarItensNoModal();
        }

        function fecharModalItens() {
            document.getElementById('modalItens').style.display = 'none';
        }

        function listarItensNoModal() {
            const div = document.getElementById('listaItens');
            div.innerHTML = "Carregando...";

            fetch(`${API_URL}/itens`)
                .then(res => res.json())
                .then(itens => {
                    if (itens.length === 0) {
                        div.innerHTML = "<p>Nenhum item.</p>";
                        return;
                    }
                    let html = `<table class="itens-table"><thead><tr><th>Item</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody>`;
                    itens.forEach(i => {
                        html += `<tr>
                            <td>${i.descricao}</td>
                            <td>R$ ${i.valor}</td>
                            <td>
                                <button onclick="verQuemComprou(${i.id}, '${i.descricao}')" style="background:#17a2b8; color:white; margin-right:5px; cursor:pointer;">üë• Ver Consumidores</button>
                                <button onclick="deletarItem(${i.id})" style="background:red; color:white; cursor:pointer;">üóëÔ∏è</button>
                            </td>
                        </tr>`;
                    });
                    html += "</tbody></table>";
                    div.innerHTML = html;
                });
        }

        async function deletarItem(id) {
            if(!confirm("Excluir item?")) return;
            const res = await fetch(`${API_URL}/itens/${id}`, { method: 'DELETE' });
            if(res.ok) {
                listarItensNoModal();
                carregarItensDoBanco();
            } else {
                alert("Erro: Item em uso.");
            }
        }

        async function verQuemComprou(idItem, nomeItem) {
            const res = await fetch(`${API_URL}/itens/${idItem}/consumidores`);
            const ids = await res.json();
            if(ids.length === 0) { alert(`Ningu√©m consumiu '${nomeItem}'.`); return; }
            
            let nomes = [];
            for(let id of ids) {
                const r = await fetch(`${API_URL}/pessoas-comanda/${id}`);
                if(r.ok) { const p = await r.json(); nomes.push(p.nome); }
            }
            alert(`Consumidores de '${nomeItem}':\n- ${nomes.join('\n- ')}`);
        }

        // --- AUXILIARES ---
        function exibirSucesso(teveVinculo) {
            const msg = document.getElementById('msgSucesso');
          if (teveVinculo) {
                msg.innerHTML = "‚úÖ Item salvo e vinculado √†s pessoas!";
            } else {
                msg.innerHTML = "üíæ Item salvo no cat√°logo (Sem v√≠nculos).";
            }
            
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        function exibirLogTecnico(checkboxes, idItem) {
          const logDiv = document.getElementById('logTecnico');
            const logContent = document.getElementById('logContent');
            logDiv.style.display = 'block';
            logContent.innerHTML = '';
            
            if (checkboxes.length === 0) {
                logContent.innerHTML += `
                    > Item ID ${idItem} atualizado/criado no Cat√°logo.<br>
                    > Nenhuma chave composta gerada Item √≥rf√£o na comanda).<br>
                    -----------------------------------------------------<br>`;
            } else {
                checkboxes.forEach(chk => {
                    logContent.innerHTML += `> Chave Composta Gerada: [Pessoa:${chk.value}] + [Comanda:${ID_COMANDA_ATUAL}] + [Item:${idItem}]<br>`;
                });
            }
        }

        window.onclick = function(ev) {
            if (ev.target == document.getElementById('modalItens')) fecharModalItens();
        }
    </script>
</body>
</html>